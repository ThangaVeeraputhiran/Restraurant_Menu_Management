<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Restaurant - IoT Kitchen Display System</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- Firebase SDK (compat for global firebase object) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div id="auth-overlay" class="auth-overlay active" aria-live="polite">
        <div class="auth-card">
            <h2>üîí Staff Login</h2>
            <p class="auth-subtitle">Sign in to manage orders, inventory, and reports.</p>
            <div class="auth-form">
                <label for="auth-email">Email</label>
                <input type="email" id="auth-email" placeholder="name@restaurant.com" autocomplete="email">
                <label for="auth-password">Password</label>
                <input type="password" id="auth-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
                <div class="auth-actions">
                    <button class="btn-primary" onclick="loginUser()">Sign In</button>
                </div>
                <button class="btn-google" onclick="signInWithGoogle()">Continue with Google</button>
                <p class="auth-info">üí¨ Need an account? Contact your restaurant admin.</p>
                <p id="auth-message" class="auth-message"></p>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üçΩÔ∏è Smart Restaurant</h1>
            <p class="subtitle">IoT-Powered Ordering System</p>
        </header>

        <!-- ESP32 Configuration Panel -->
        <div class="config-panel">
            <h3>‚öôÔ∏è Kitchen Display Settings</h3>
            <div class="config-row">
                <label for="esp32-ip">ESP32 IP Address:</label>
                <input type="text" id="esp32-ip" placeholder="192.168.1.100" value="192.168.1.100">
            </div>
            <div class="config-row">
                <label for="table-number">Table Number:</label>
                <input type="number" id="table-number" min="1" max="50" value="1">
            </div>
            <div class="config-actions">
                <button class="btn-test" onclick="testConnection()">Test Connection</button>
                <button class="btn-inventory" onclick="openInventoryDashboard()">üì¶ Manage Inventory</button>
                <button class="btn-analytics" onclick="openAnalyticsDashboard()">üìä Analytics & Reports</button>
                <button class="btn-secondary btn-logout" id="btn-logout" onclick="logoutUser()">Sign Out</button>
                <span id="auth-status" class="auth-status"></span>
                <span id="connection-status"></span>
            </div>
        </div>

        <!-- Restock Alert (will be dynamically inserted) -->
        <div id="restock-alert" class="restock-alert" style="display: none;"></div>

        <!-- Menu Section -->
        <div class="menu-container">
            <h2>üìã Menu</h2>

            <!-- Beverages -->
            <div class="category">
                <h3 class="category-title">‚òï Beverages</h3>
                <div class="menu-grid">
                    <div class="menu-item" data-name="Tea" data-price="10">
                        <div class="item-info">
                            <span class="item-name">Tea</span>
                            <span class="item-price">‚Çπ10</span>
                        </div>
                        <div class="item-controls">
                            <button class="btn-minus" onclick="updateQuantity('Tea', -1)">‚àí</button>
                            <span class="quantity" id="qty-Tea">0</span>
                            <button class="btn-plus" onclick="updateQuantity('Tea', 1)">+</button>
                        </div>
                    </div>

                    <div class="menu-item" data-name="Coffee" data-price="15">
                        <div class="item-info">
                            <span class="item-name">Coffee</span>
                            <span class="item-price">‚Çπ15</span>
                        </div>
                        <div class="item-controls">
                            <button class="btn-minus" onclick="updateQuantity('Coffee', -1)">‚àí</button>
                            <span class="quantity" id="qty-Coffee">0</span>
                            <button class="btn-plus" onclick="updateQuantity('Coffee', 1)">+</button>
                        </div>
                    </div>

                    <div class="menu-item" data-name="Horlicks" data-price="20">
                        <div class="item-info">
                            <span class="item-name">Horlicks</span>
                            <span class="item-price">‚Çπ20</span>
                        </div>
                        <div class="item-controls">
                            <button class="btn-minus" onclick="updateQuantity('Horlicks', -1)">‚àí</button>
                            <span class="quantity" id="qty-Horlicks">0</span>
                            <button class="btn-plus" onclick="updateQuantity('Horlicks', 1)">+</button>
                        </div>
                    </div>

                    <div class="menu-item" data-name="Boost" data-price="20">
                        <div class="item-info">
                            <span class="item-name">Boost</span>
                            <span class="item-price">‚Çπ20</span>
                        </div>
                        <div class="item-controls">
                            <button class="btn-minus" onclick="updateQuantity('Boost', -1)">‚àí</button>
                            <span class="quantity" id="qty-Boost">0</span>
                            <button class="btn-plus" onclick="updateQuantity('Boost', 1)">+</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Snacks -->
            <div class="category">
                <h3 class="category-title">üç™ Snacks</h3>
                <div class="menu-grid">
                    <div class="menu-item" data-name="Vada" data-price="10">
                        <div class="item-info">
                            <span class="item-name">Vada</span>
                            <span class="item-price">‚Çπ10</span>
                        </div>
                        <div class="item-controls">
                            <button class="btn-minus" onclick="updateQuantity('Vada', -1)">‚àí</button>
                            <span class="quantity" id="qty-Vada">0</span>
                            <button class="btn-plus" onclick="updateQuantity('Vada', 1)">+</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tiffin / Meals -->
            <div class="category">
                <h3 class="category-title">üçõ Tiffin / Meals</h3>
                <div class="menu-grid">
                    <div class="menu-item" data-name="Idly (Plate)" data-price="40">
                        <div class="item-info">
                            <span class="item-name">Idly (Plate)</span>
                            <span class="item-price">‚Çπ40</span>
                        </div>
                        <div class="item-controls">
                            <button class="btn-minus" onclick="updateQuantity('Idly (Plate)', -1)">‚àí</button>
                            <span class="quantity" id="qty-Idly (Plate)">0</span>
                            <button class="btn-plus" onclick="updateQuantity('Idly (Plate)', 1)">+</button>
                        </div>
                    </div>

                    <div class="menu-item" data-name="Poori (Plate)" data-price="40">
                        <div class="item-info">
                            <span class="item-name">Poori (Plate)</span>
                            <span class="item-price">‚Çπ40</span>
                        </div>
                        <div class="item-controls">
                            <button class="btn-minus" onclick="updateQuantity('Poori (Plate)', -1)">‚àí</button>
                            <span class="quantity" id="qty-Poori (Plate)">0</span>
                            <button class="btn-plus" onclick="updateQuantity('Poori (Plate)', 1)">+</button>
                        </div>
                    </div>

                    <div class="menu-item" data-name="Dosa" data-price="40">
                        <div class="item-info">
                            <span class="item-name">Dosa</span>
                            <span class="item-price">‚Çπ40</span>
                        </div>
                        <div class="item-controls">
                            <button class="btn-minus" onclick="updateQuantity('Dosa', -1)">‚àí</button>
                            <span class="quantity" id="qty-Dosa">0</span>
                            <button class="btn-plus" onclick="updateQuantity('Dosa', 1)">+</button>
                        </div>
                    </div>

                    <div class="menu-item" data-name="Masal Dosa" data-price="50">
                        <div class="item-info">
                            <span class="item-name">Masal Dosa</span>
                            <span class="item-price">‚Çπ50</span>
                        </div>
                        <div class="item-controls">
                            <button class="btn-minus" onclick="updateQuantity('Masal Dosa', -1)">‚àí</button>
                            <span class="quantity" id="qty-Masal Dosa">0</span>
                            <button class="btn-plus" onclick="updateQuantity('Masal Dosa', 1)">+</button>
                        </div>
                    </div>

                    <div class="menu-item" data-name="Paper Roast" data-price="55">
                        <div class="item-info">
                            <span class="item-name">Paper Roast</span>
                            <span class="item-price">‚Çπ55</span>
                        </div>
                        <div class="item-controls">
                            <button class="btn-minus" onclick="updateQuantity('Paper Roast', -1)">‚àí</button>
                            <span class="quantity" id="qty-Paper Roast">0</span>
                            <button class="btn-plus" onclick="updateQuantity('Paper Roast', 1)">+</button>
                        </div>
                    </div>

                    <div class="menu-item" data-name="Ghee Roast" data-price="60">
                        <div class="item-info">
                            <span class="item-name">Ghee Roast</span>
                            <span class="item-price">‚Çπ60</span>
                        </div>
                        <div class="item-controls">
                            <button class="btn-minus" onclick="updateQuantity('Ghee Roast', -1)">‚àí</button>
                            <span class="quantity" id="qty-Ghee Roast">0</span>
                            <button class="btn-plus" onclick="updateQuantity('Ghee Roast', 1)">+</button>
                        </div>
                    </div>

                    <div class="menu-item" data-name="Onion Dosa" data-price="50">
                        <div class="item-info">
                            <span class="item-name">Onion Dosa</span>
                            <span class="item-price">‚Çπ50</span>
                        </div>
                        <div class="item-controls">
                            <button class="btn-minus" onclick="updateQuantity('Onion Dosa', -1)">‚àí</button>
                            <span class="quantity" id="qty-Onion Dosa">0</span>
                            <button class="btn-plus" onclick="updateQuantity('Onion Dosa', 1)">+</button>
                        </div>
                    </div>

                    <div class="menu-item" data-name="Uthappam" data-price="40">
                        <div class="item-info">
                            <span class="item-name">Uthappam</span>
                            <span class="item-price">‚Çπ40</span>
                        </div>
                        <div class="item-controls">
                            <button class="btn-minus" onclick="updateQuantity('Uthappam', -1)">‚àí</button>
                            <span class="quantity" id="qty-Uthappam">0</span>
                            <button class="btn-plus" onclick="updateQuantity('Uthappam', 1)">+</button>
                        </div>
                    </div>

                    <div class="menu-item" data-name="Onion Uthappam" data-price="50">
                        <div class="item-info">
                            <span class="item-name">Onion Uthappam</span>
                            <span class="item-price">‚Çπ50</span>
                        </div>
                        <div class="item-controls">
                            <button class="btn-minus" onclick="updateQuantity('Onion Uthappam', -1)">‚àí</button>
                            <span class="quantity" id="qty-Onion Uthappam">0</span>
                            <button class="btn-plus" onclick="updateQuantity('Onion Uthappam', 1)">+</button>
                        </div>
                    </div>

                    <div class="menu-item" data-name="Chapathi" data-price="30">
                        <div class="item-info">
                            <span class="item-name">Chapathi</span>
                            <span class="item-price">‚Çπ30</span>
                        </div>
                        <div class="item-controls">
                            <button class="btn-minus" onclick="updateQuantity('Chapathi', -1)">‚àí</button>
                            <span class="quantity" id="qty-Chapathi">0</span>
                            <button class="btn-plus" onclick="updateQuantity('Chapathi', 1)">+</button>
                        </div>
                    </div>

                    <div class="menu-item" data-name="Porota (Plate)" data-price="40">
                        <div class="item-info">
                            <span class="item-name">Porota (Plate)</span>
                            <span class="item-price">‚Çπ40</span>
                        </div>
                        <div class="item-controls">
                            <button class="btn-minus" onclick="updateQuantity('Porota (Plate)', -1)">‚àí</button>
                            <span class="quantity" id="qty-Porota (Plate)">0</span>
                            <button class="btn-plus" onclick="updateQuantity('Porota (Plate)', 1)">+</button>
                        </div>
                    </div>

                    <div class="menu-item" data-name="Meals" data-price="70">
                        <div class="item-info">
                            <span class="item-name">Meals</span>
                            <span class="item-price">‚Çπ70</span>
                        </div>
                        <div class="item-controls">
                            <button class="btn-minus" onclick="updateQuantity('Meals', -1)">‚àí</button>
                            <span class="quantity" id="qty-Meals">0</span>
                            <button class="btn-plus" onclick="updateQuantity('Meals', 1)">+</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sticky Cart Bar -->
        <div class="cart-bar" id="cart-bar">
            <div class="cart-summary">
                <span class="cart-count">üõí <span id="total-items">0</span> Items</span>
                <span class="cart-total">Total: ‚Çπ<span id="total-amount">0</span></span>
            </div>
            <button class="btn-checkout" onclick="openCheckout()">View Cart</button>
        </div>

        <!-- Checkout Modal -->
        <div class="modal" id="checkout-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üõí Your Order</h2>
                    <button class="btn-close" onclick="closeCheckout()">‚úï</button>
                </div>
                <div class="modal-body">
                    <div id="cart-items"></div>
                    <div class="order-summary">
                        <div class="summary-row">
                            <span>Total Items:</span>
                            <span id="checkout-total-items">0</span>
                        </div>
                        <div class="summary-row grand-total">
                            <span>Grand Total:</span>
                            <span>‚Çπ<span id="checkout-total-amount">0</span></span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeCheckout()">Continue Shopping</button>
                    <button class="btn-primary" onclick="confirmOrder()">üì§ Send to Kitchen</button>
                </div>
            </div>
        </div>

        <!-- Order Confirmation Modal -->
        <div class="modal" id="confirmation-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>‚úÖ Order Sent!</h2>
                </div>
                <div class="modal-body">
                    <div class="success-message">
                        <p>Your order has been successfully sent to the kitchen display!</p>
                        <p class="order-details" id="order-confirmation-details"></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-primary" onclick="closeConfirmation()">New Order</button>
                </div>
            </div>
        </div>

        <!-- Inventory Management Dashboard Modal -->
        <div class="modal" id="inventory-modal">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h2>üì¶ Inventory Management</h2>
                    <button class="btn-close" onclick="closeInventoryDashboard()">‚úï</button>
                </div>
                <div class="modal-body">
                    <!-- Inventory Statistics -->
                    <div class="inventory-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="stat-total-items">0</div>
                            <div class="stat-label">Total Items</div>
                        </div>
                        <div class="stat-card stat-ok">
                            <div class="stat-value" id="stat-ok-stock">0</div>
                            <div class="stat-label">In Stock</div>
                        </div>
                        <div class="stat-card stat-low">
                            <div class="stat-value" id="stat-low-stock">0</div>
                            <div class="stat-label">Low Stock</div>
                        </div>
                        <div class="stat-card stat-critical">
                            <div class="stat-value" id="stat-critical-stock">0</div>
                            <div class="stat-label">Critical/Out</div>
                        </div>
                    </div>

                    <!-- Inventory List -->
                    <div class="inventory-list" id="inventory-list">
                        <!-- Dynamically populated -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="exportInventory()">üì• Export Data</button>
                    <button class="btn-success" onclick="openAddNewItem()">‚ûï Add New Item</button>
                    <button class="btn-warning" onclick="resetInventory()">üîÑ Reset All</button>
                    <button class="btn-primary" onclick="closeInventoryDashboard()">Close</button>
                </div>
            </div>
        </div>

        <!-- Stock Adjustment Modal -->
        <div class="modal" id="adjust-modal">
            <div class="modal-content modal-small">
                <div class="modal-header">
                    <h2>Adjust Stock</h2>
                    <button class="btn-close" onclick="closeStockAdjust()">‚úï</button>
                </div>
                <div class="modal-body">
                    <h3 id="adjust-item-name" class="adjust-item-title"></h3>
                    <p id="adjust-current-stock" class="adjust-current"></p>
                    
                    <div class="adjust-form">
                        <div class="adjust-radio-group">
                            <label class="radio-label">
                                <input type="radio" name="adjust-action" value="add" checked>
                                Add to Stock
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="adjust-action" value="remove">
                                Remove from Stock
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="adjust-action" value="set">
                                Set Exact Amount
                            </label>
                        </div>
                        
                        <div class="adjust-input-group">
                            <label for="adjust-quantity">Quantity:</label>
                            <input type="number" id="adjust-quantity" min="1" placeholder="Enter quantity">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeStockAdjust()">Cancel</button>
                    <button class="btn-primary" onclick="applyStockAdjustment()">Apply</button>
                </div>
            </div>
        </div>

        <!-- Add New Item Modal -->
        <div class="modal" id="add-item-modal">
            <div class="modal-content modal-medium">
                <div class="modal-header">
                    <h2>‚ûï Add New Menu Item</h2>
                    <button class="btn-close" onclick="closeAddNewItem()">‚úï</button>
                </div>
                <div class="modal-body">
                    <form id="new-item-form" class="add-item-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="new-item-name">Item Name *</label>
                                <input type="text" id="new-item-name" placeholder="e.g., Samosa" required>
                            </div>
                            <div class="form-group">
                                <label for="new-item-price">Price (‚Çπ) *</label>
                                <input type="number" id="new-item-price" min="1" step="0.01" placeholder="e.g., 20" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="new-item-category">Category *</label>
                                <select id="new-item-category" required>
                                    <option value="Beverages">‚òï Beverages</option>
                                    <option value="Snacks">üç™ Snacks</option>
                                    <option value="Tiffin/Meals">üçõ Tiffin/Meals</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="new-item-unit">Unit *</label>
                                <input type="text" id="new-item-unit" placeholder="e.g., pieces, cups, plates" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="new-item-stock">Initial Stock *</label>
                                <input type="number" id="new-item-stock" min="0" placeholder="e.g., 50" required>
                            </div>
                            <div class="form-group">
                                <label for="new-item-low-threshold">Low Stock Alert *</label>
                                <input type="number" id="new-item-low-threshold" min="1" placeholder="e.g., 15" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="new-item-critical-threshold">Critical Stock Alert *</label>
                                <input type="number" id="new-item-critical-threshold" min="1" placeholder="e.g., 5" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeAddNewItem()">Cancel</button>
                    <button class="btn-primary" onclick="addNewMenuItem()">Add Item</button>
                </div>
            </div>
        </div>

        <!-- Analytics Dashboard Modal -->
        <div class="modal" id="analytics-modal">
            <div class="modal-content modal-xlarge">
                <div class="modal-header">
                    <h2>üìä Analytics & Billing Reports</h2>
                    <button class="btn-close" onclick="closeAnalyticsDashboard()">‚úï</button>
                </div>
                <div class="modal-body">
                    <!-- Filter Section -->
                    <div class="analytics-filters">
                        <h3>Period: <span id="analytics-period-label">Today</span></h3>
                        <div class="filter-buttons">
                            <button class="analytics-filter-btn active" data-period="today" onclick="updateAnalyticsDashboard('today'); this.parentElement.querySelectorAll('.analytics-filter-btn').forEach(b => b.classList.remove('active')); this.classList.add('active');">Today</button>
                            <button class="analytics-filter-btn" data-period="month" onclick="updateAnalyticsDashboard('month'); this.parentElement.querySelectorAll('.analytics-filter-btn').forEach(b => b.classList.remove('active')); this.classList.add('active');">This Month</button>
                            <button class="analytics-filter-btn" data-period="year" onclick="updateAnalyticsDashboard('year'); this.parentElement.querySelectorAll('.analytics-filter-btn').forEach(b => b.classList.remove('active')); this.classList.add('active');">This Year</button>
                        </div>
                        <div class="custom-date-filter">
                            <input type="date" id="analytics-start-date">
                            <span>to</span>
                            <input type="date" id="analytics-end-date">
                            <button class="btn-apply-filter" onclick="updateAnalyticsDashboard('custom')">Apply</button>
                        </div>
                    </div>

                    <!-- Summary Statistics -->
                    <div class="analytics-summary">
                        <div class="summary-card">
                            <div class="summary-icon">üì¶</div>
                            <div class="summary-info">
                                <div class="summary-value" id="stat-total-orders">0</div>
                                <div class="summary-label">Total Orders</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon">üí∞</div>
                            <div class="summary-info">
                                <div class="summary-value" id="stat-total-revenue">‚Çπ0</div>
                                <div class="summary-label">Total Revenue</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon">üìä</div>
                            <div class="summary-info">
                                <div class="summary-value" id="stat-avg-order">‚Çπ0</div>
                                <div class="summary-label">Avg Order Value</div>
                            </div>
                        </div>
                    </div>

                    <!-- Hourly Traffic Analysis -->
                    <div class="analytics-section">
                        <h3>‚è∞ Hourly Traffic Analysis</h3>
                        <p id="peak-hour-info" class="peak-info"></p>
                        <div class="hourly-traffic-chart" id="hourly-traffic-chart">
                            <!-- Dynamically populated -->
                        </div>
                    </div>

                    <!-- Top Selling Items -->
                    <div class="analytics-section">
                        <h3>üèÜ Top Selling Items</h3>
                        <div class="top-items-list" id="top-items-list">
                            <!-- Dynamically populated -->
                        </div>
                    </div>

                    <!-- Order History -->
                    <div class="analytics-section">
                        <h3>üìã Order History</h3>
                        <div class="order-list" id="order-list">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-danger" onclick="clearOrderHistory()">üóëÔ∏è Clear History</button>
                    <button class="btn-secondary" onclick="exportAnalyticsReport()">üì• Export Report</button>
                    <button class="btn-primary" onclick="closeAnalyticsDashboard()">Close</button>
                </div>
            </div>
        </div>

    <script>
        // ===================================
        // COMPLETE RESTAURANT MANAGEMENT SYSTEM
        // ===================================
        console.log('üçΩÔ∏è Kitchen Alert System Loading...');
        
        const menuItems = {
            "Tea": 10,
            "Coffee": 15,
            "Horlicks": 20,
            "Boost": 20,
            "Vada": 10,
            "Idly (Plate)": 40,
            "Poori (Plate)": 40,
            "Dosa": 40,
            "Masal Dosa": 50,
            "Paper Roast": 55,
            "Ghee Roast": 60,
            "Onion Dosa": 50,
            "Uthappam": 40,
            "Onion Uthappam": 50,
            "Chapathi": 30,
            "Porota (Plate)": 40,
            "Meals": 70
        };

        let cart = {};
        let inventory = {};
        let lastLocalInventoryUpdate = 0;

        const defaultInventory = {
            "Tea": { currentStock: 100, unit: "cups", lowThreshold: 20, criticalThreshold: 5, category: "Beverages" },
            "Coffee": { currentStock: 100, unit: "cups", lowThreshold: 20, criticalThreshold: 5, category: "Beverages" },
            "Horlicks": { currentStock: 50, unit: "cups", lowThreshold: 15, criticalThreshold: 5, category: "Beverages" },
            "Boost": { currentStock: 50, unit: "cups", lowThreshold: 15, criticalThreshold: 5, category: "Beverages" },
            "Vada": { currentStock: 80, unit: "pieces", lowThreshold: 15, criticalThreshold: 5, category: "Snacks" },
            "Idly (Plate)": { currentStock: 50, unit: "plates", lowThreshold: 10, criticalThreshold: 3, category: "Tiffin/Meals" },
            "Poori (Plate)": { currentStock: 40, unit: "plates", lowThreshold: 10, criticalThreshold: 3, category: "Tiffin/Meals" },
            "Dosa": { currentStock: 60, unit: "pieces", lowThreshold: 15, criticalThreshold: 5, category: "Tiffin/Meals" },
            "Masal Dosa": { currentStock: 50, unit: "pieces", lowThreshold: 12, criticalThreshold: 4, category: "Tiffin/Meals" },
            "Paper Roast": { currentStock: 40, unit: "pieces", lowThreshold: 10, criticalThreshold: 3, category: "Tiffin/Meals" },
            "Ghee Roast": { currentStock: 40, unit: "pieces", lowThreshold: 10, criticalThreshold: 3, category: "Tiffin/Meals" },
            "Onion Dosa": { currentStock: 45, unit: "pieces", lowThreshold: 12, criticalThreshold: 4, category: "Tiffin/Meals" },
            "Uthappam": { currentStock: 35, unit: "pieces", lowThreshold: 10, criticalThreshold: 3, category: "Tiffin/Meals" },
            "Onion Uthappam": { currentStock: 35, unit: "pieces", lowThreshold: 10, criticalThreshold: 3, category: "Tiffin/Meals" },
            "Chapathi": { currentStock: 50, unit: "pieces", lowThreshold: 15, criticalThreshold: 5, category: "Tiffin/Meals" },
            "Porota (Plate)": { currentStock: 40, unit: "plates", lowThreshold: 10, criticalThreshold: 3, category: "Tiffin/Meals" },
            "Meals": { currentStock: 30, unit: "plates", lowThreshold: 8, criticalThreshold: 2, category: "Tiffin/Meals" }
        };

        // ===================================
        // INVENTORY FUNCTIONS
        // ===================================
        function initializeInventory() {
            const saved = localStorage.getItem('restaurantInventory');
            if (saved) {
                inventory = JSON.parse(saved);
                for (const itemName in defaultInventory) {
                    if (!inventory[itemName]) {
                        inventory[itemName] = { ...defaultInventory[itemName], lastRestocked: new Date().toISOString() };
                    }
                }
            } else {
                for (const itemName in defaultInventory) {
                    inventory[itemName] = { ...defaultInventory[itemName], lastRestocked: new Date().toISOString() };
                }
            }
            saveInventory();
        }

        function saveInventory() {
            localStorage.setItem('restaurantInventory', JSON.stringify(inventory));
        }

        function getStockStatus(itemName) {
            const item = inventory[itemName];
            if (!item) return 'ok';
            if (item.currentStock <= 0) return 'out';
            if (item.currentStock <= item.criticalThreshold) return 'critical';
            if (item.currentStock <= item.lowThreshold) return 'low';
            return 'ok';
        }

        function deductStock(cart) {
            for (const itemName in cart) {
                if (inventory[itemName]) {
                    inventory[itemName].currentStock -= cart[itemName].quantity;
                    if (inventory[itemName].currentStock < 0) inventory[itemName].currentStock = 0;
                }
            }
            lastLocalInventoryUpdate = Date.now();
            saveInventory();
            updateStockDisplay();
        }

        function addStock(itemName, quantity) {
            if (inventory[itemName]) {
                inventory[itemName].currentStock += quantity;
                inventory[itemName].lastRestocked = new Date().toISOString();
                lastLocalInventoryUpdate = Date.now();
                saveInventory();
                updateStockDisplay();
                updateInventoryDashboard();
            }
        }

        function setStock(itemName, quantity) {
            if (inventory[itemName]) {
                inventory[itemName].currentStock = quantity;
                inventory[itemName].lastRestocked = new Date().toISOString();
                lastLocalInventoryUpdate = Date.now();
                saveInventory();
                updateStockDisplay();
                updateInventoryDashboard();
            }
        }

        // ===================================
        // CART FUNCTIONS
        // ===================================
        function updateQuantity(itemName, change) {
            if (!cart[itemName]) {
                cart[itemName] = { quantity: 0, price: menuItems[itemName] };
            }
            
            const newQuantity = cart[itemName].quantity + change;
            
            if (change > 0 && inventory[itemName] && inventory[itemName].currentStock < newQuantity) {
                alert(`Sorry! Only ${inventory[itemName].currentStock} ${inventory[itemName].unit} available.`);
                return;
            }
            
            cart[itemName].quantity = newQuantity;
            
            if (cart[itemName].quantity <= 0) {
                cart[itemName].quantity = 0;
                delete cart[itemName];
            }
            
            updateQuantityDisplay(itemName);
            updateCartBar();
        }

        function updateQuantityDisplay(itemName) {
            const qtyElement = document.getElementById(`qty-${itemName}`);
            if (qtyElement) {
                const quantity = cart[itemName] ? cart[itemName].quantity : 0;
                qtyElement.textContent = quantity;
            }
        }

        function updateCartBar() {
            let totalItems = 0;
            let totalAmount = 0;
            
            for (const itemName in cart) {
                totalItems += cart[itemName].quantity;
                totalAmount += cart[itemName].quantity * cart[itemName].price;
            }
            
            document.getElementById('total-items').textContent = totalItems;
            document.getElementById('total-amount').textContent = totalAmount;
        }

        function updateStockDisplay() {
            for (const itemName in inventory) {
                const menuItem = document.querySelector(`.menu-item[data-name="${itemName}"]`);
                if (!menuItem) continue;
                
                const itemInfo = menuItem.querySelector('.item-info');
                let stockDisplay = itemInfo.querySelector('.stock-display');
                
                if (!stockDisplay) {
                    stockDisplay = document.createElement('div');
                    stockDisplay.className = 'stock-display';
                    stockDisplay.style.fontSize = '0.85rem';
                    stockDisplay.style.color = '#6c757d';
                    stockDisplay.style.marginTop = '4px';
                    itemInfo.appendChild(stockDisplay);
                }
                
                const stock = inventory[itemName].currentStock;
                const status = getStockStatus(itemName);
                
                stockDisplay.textContent = `Stock: ${stock} ${inventory[itemName].unit}`;
                
                const plusBtn = menuItem.querySelector('.btn-plus');
                if (stock <= 0) {
                    stockDisplay.style.color = '#dc3545';
                    stockDisplay.style.fontWeight = 'bold';
                    if (plusBtn) plusBtn.disabled = true;
                } else {
                    if (plusBtn) plusBtn.disabled = false;
                    if (status === 'critical') {
                        stockDisplay.style.color = '#dc3545';
                        stockDisplay.style.fontWeight = 'bold';
                    } else if (status === 'low') {
                        stockDisplay.style.color = '#ffc107';
                        stockDisplay.style.fontWeight = '600';
                    } else {
                        stockDisplay.style.color = '#28a745';
                    }
                }
            }
        }

        function clearCart() {
            cart = {};
            for (const itemName in menuItems) {
                updateQuantityDisplay(itemName);
            }
            updateCartBar();
        }

        // ===================================
        // CHECKOUT FUNCTIONS
        // ===================================
        function openCheckout() {
            if (Object.keys(cart).length === 0) {
                alert('Your cart is empty!');
                return;
            }
            
            const cartItemsContainer = document.getElementById('cart-items');
            cartItemsContainer.innerHTML = '';
            
            let totalQuantity = 0;
            let grandTotal = 0;
            
            for (const itemName in cart) {
                const item = cart[itemName];
                const itemTotal = item.quantity * item.price;
                totalQuantity += item.quantity;
                grandTotal += itemTotal;
                
                const cartItemElement = document.createElement('div');
                cartItemElement.className = 'cart-item';
                cartItemElement.innerHTML = `
                    <div class="cart-item-info">
                        <div class="cart-item-name">${itemName}</div>
                        <div class="cart-item-details">${item.quantity} √ó ‚Çπ${item.price} = ‚Çπ${itemTotal}</div>
                    </div>
                    <div class="cart-item-total">‚Çπ${itemTotal}</div>
                `;
                cartItemsContainer.appendChild(cartItemElement);
            }
            
            document.getElementById('checkout-total-items').textContent = totalQuantity;
            document.getElementById('checkout-total-amount').textContent = grandTotal;
            document.getElementById('checkout-modal').classList.add('active');
        }

        function closeCheckout() {
            document.getElementById('checkout-modal').classList.remove('active');
        }

        async function confirmOrder() {
            const esp32IP = document.getElementById('esp32-ip').value.trim();
            const tableNumber = document.getElementById('table-number').value;
            
            if (!esp32IP) {
                alert('Please enter ESP32 IP address!');
                return;
            }
            
            if (!tableNumber || tableNumber < 1) {
                alert('Please enter a valid table number!');
                return;
            }
            
            const orderData = prepareOrderData(tableNumber);
            closeCheckout();
            
            try {
                await sendOrderToESP32(esp32IP, orderData);
                processOrder(orderData);
                showConfirmation(orderData);
                clearCart();
            } catch (error) {
                console.error('Order error:', error);
                alert('Note: Could not connect to ESP32, but order saved locally.');
                processOrder(orderData);
                showConfirmation(orderData);
                clearCart();
            }
        }

        function prepareOrderData(tableNumber) {
            const items = [];
            let total = 0;
            
            for (const itemName in cart) {
                const item = cart[itemName];
                items.push({ name: itemName, qty: item.quantity });
                total += item.quantity * item.price;
            }
            
            const now = new Date();
            const time = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            
            return {
                table: tableNumber.toString(),
                items: items,
                total: total,
                time: time
            };
        }

        async function sendOrderToESP32(esp32IP, orderData) {
            const url = `http://${esp32IP}/order`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData),
                timeout: 5000
            });
            
            if (!response.ok) throw new Error('ESP32 connection failed');
            return await response.json();
        }

        function processOrder(orderData) {
            deductStock(cart);
            saveOrderToHistory(orderData);
            
            // Also save to Firebase for real-time sync and persistent storage
            if (typeof saveOrderToFirebase === 'function') {
                try {
                    saveOrderToFirebase(orderData);
                } catch (error) {
                    console.warn('Firebase not yet initialized, but order saved locally');
                }
            }

            if (typeof syncInventoryToFirebase === 'function') {
                try {
                    syncInventoryToFirebase();
                } catch (error) {
                    console.warn('Inventory sync failed, will retry on next update');
                }
            }
        }

        function showConfirmation(orderData) {
            const detailsElement = document.getElementById('order-confirmation-details');
            let itemsList = '';
            orderData.items.forEach(item => {
                itemsList += `${item.name} √ó ${item.qty}\n`;
            });
            
            detailsElement.textContent = `
Table: ${orderData.table}
Time: ${orderData.time}

Items:
${itemsList}
Total: ‚Çπ${orderData.total}

‚úì Order sent to kitchen display!
            `.trim();
            
            document.getElementById('confirmation-modal').classList.add('active');
        }

        function closeConfirmation() {
            document.getElementById('confirmation-modal').classList.remove('active');
        }

        async function testConnection() {
            const esp32IP = document.getElementById('esp32-ip').value.trim();
            const statusElement = document.getElementById('connection-status');
            
            if (!esp32IP) {
                statusElement.textContent = '‚ùå Please enter IP address';
                statusElement.className = 'error';
                return;
            }
            
            statusElement.textContent = 'üîÑ Testing...';
            statusElement.className = '';
            
            try {
                const response = await fetch(`http://${esp32IP}/test`, { timeout: 5000 });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                statusElement.textContent = '‚úÖ Connection successful!';
                statusElement.className = 'success';
                
                setTimeout(() => {
                    statusElement.textContent = '';
                    statusElement.className = '';
                }, 3000);
            } catch (error) {
                statusElement.textContent = `‚ùå Failed: ${error.message}`;
                statusElement.className = 'error';
            }
        }

        // ===================================
        // ORDER HISTORY & ANALYTICS
        // ===================================
        function saveOrderToHistory(orderData) {
            const orders = JSON.parse(localStorage.getItem('orderHistory') || '[]');
            const order = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                table: orderData.table,
                items: orderData.items,
                total: orderData.total,
                time: orderData.time,
                date: new Date().toLocaleDateString(),
                hour: new Date().getHours()
            };
            orders.push(order);
            localStorage.setItem('orderHistory', JSON.stringify(orders));
        }

        function getAllOrders() {
            return JSON.parse(localStorage.getItem('orderHistory') || '[]');
        }

        function getOrdersByDateRange(startDate, endDate) {
            const orders = getAllOrders();
            return orders.filter(order => {
                const orderDate = new Date(order.timestamp);
                return orderDate >= startDate && orderDate <= endDate;
            });
        }

        function getTodayOrders() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            return getOrdersByDateRange(today, tomorrow);
        }

        function getMonthOrders() {
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
            return getOrdersByDateRange(firstDay, lastDay);
        }

        function getYearOrders() {
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), 0, 1);
            const lastDay = new Date(now.getFullYear(), 11, 31, 23, 59, 59);
            return getOrdersByDateRange(firstDay, lastDay);
        }

        function calculateRevenue(orders) {
            return orders.reduce((sum, order) => sum + order.total, 0);
        }

        function getHourlyTraffic(orders) {
            const hourlyData = {};
            for (let i = 0; i < 24; i++) {
                hourlyData[i] = { count: 0, revenue: 0 };
            }
            orders.forEach(order => {
                const hour = order.hour;
                hourlyData[hour].count++;
                hourlyData[hour].revenue += order.total;
            });
            return hourlyData;
        }

        function getTopSellingItems(orders) {
            const itemCounts = {};
            orders.forEach(order => {
                order.items.forEach(item => {
                    if (!itemCounts[item.name]) {
                        itemCounts[item.name] = { count: 0, revenue: 0 };
                    }
                    itemCounts[item.name].count += item.qty;
                    itemCounts[item.name].revenue += item.qty * (menuItems[item.name] || 0);
                });
            });
            
            const items = Object.keys(itemCounts).map(name => ({
                name: name,
                count: itemCounts[name].count,
                revenue: itemCounts[name].revenue
            }));
            
            return items.sort((a, b) => b.count - a.count);
        }

        // ===================================
        // INVENTORY DASHBOARD
        // ===================================
        function openInventoryDashboard() {
            updateInventoryDashboard();
            document.getElementById('inventory-modal').classList.add('active');
        }

        function closeInventoryDashboard() {
            document.getElementById('inventory-modal').classList.remove('active');
        }

        function updateInventoryDashboard() {
            const inventoryListElement = document.getElementById('inventory-list');
            if (!inventoryListElement) return;
            
            inventoryListElement.innerHTML = '';
            
            const categories = { 'Beverages': [], 'Snacks': [], 'Tiffin/Meals': [] };
            
            for (const itemName in inventory) {
                const item = inventory[itemName];
                const category = item.category || 'Other';
                if (!categories[category]) categories[category] = [];
                categories[category].push({ name: itemName, ...item });
            }
            
            for (const categoryName in categories) {
                if (categories[categoryName].length === 0) continue;
                
                const categorySection = document.createElement('div');
                categorySection.className = 'inventory-category';
                
                const categoryTitle = document.createElement('h3');
                categoryTitle.className = 'inventory-category-title';
                categoryTitle.textContent = categoryName;
                categorySection.appendChild(categoryTitle);
                
                categories[categoryName].forEach(item => {
                    const status = getStockStatus(item.name);
                    
                    const itemRow = document.createElement('div');
                    itemRow.className = `inventory-item inventory-status-${status}`;
                    
                    itemRow.innerHTML = `
                        <div class="inventory-item-info">
                            <div class="inventory-item-name">${item.name}</div>
                            <div class="inventory-item-stock">
                                <span class="stock-count">${item.currentStock} ${item.unit}</span>
                                <span class="stock-status-badge status-${status}">${status.toUpperCase()}</span>
                            </div>
                        </div>
                        <div class="inventory-item-controls">
                            <button class="btn-stock-adjust" onclick="openStockAdjust('${item.name}')">Adjust Stock</button>
                            <button class="btn-stock-quick" onclick="quickAddStock('${item.name}', 10)">+10</button>
                            <button class="btn-stock-remove" onclick="quickRemoveStock('${item.name}', 10)">-10</button>
                            <button class="btn-stock-delete" onclick="removeMenuItem('${item.name}')">Remove Item</button>
                        </div>
                    `;
                    
                    categorySection.appendChild(itemRow);
                });
                
                inventoryListElement.appendChild(categorySection);
            }
            
            updateInventoryStats();
        }

        function updateInventoryStats() {
            const stats = { total: 0, ok: 0, low: 0, critical: 0, out: 0 };
            
            for (const itemName in inventory) {
                stats.total++;
                const status = getStockStatus(itemName);
                stats[status]++;
            }
            
            document.getElementById('stat-total-items').textContent = stats.total;
            document.getElementById('stat-ok-stock').textContent = stats.ok;
            document.getElementById('stat-low-stock').textContent = stats.low;
            document.getElementById('stat-critical-stock').textContent = stats.critical + stats.out;
        }

        function openStockAdjust(itemName) {
            const item = inventory[itemName];
            document.getElementById('adjust-item-name').textContent = itemName;
            document.getElementById('adjust-current-stock').textContent = `Current: ${item.currentStock} ${item.unit}`;
            document.getElementById('adjust-quantity').value = '';
            document.getElementById('adjust-modal').setAttribute('data-item', itemName);
            document.getElementById('adjust-modal').classList.add('active');
        }

        function closeStockAdjust() {
            document.getElementById('adjust-modal').classList.remove('active');
        }

        function applyStockAdjustment() {
            const itemName = document.getElementById('adjust-modal').getAttribute('data-item');
            const action = document.querySelector('input[name="adjust-action"]:checked').value;
            const quantity = parseInt(document.getElementById('adjust-quantity').value);
            
            if (isNaN(quantity) || quantity <= 0) {
                alert('Please enter a valid quantity');
                return;
            }
            
            if (action === 'add') {
                addStock(itemName, quantity);
            } else if (action === 'set') {
                setStock(itemName, quantity);
            } else if (action === 'remove') {
                const currentStock = inventory[itemName].currentStock;
                const newStock = Math.max(0, currentStock - quantity);
                setStock(itemName, newStock);
            }
            
            closeStockAdjust();
        }

        function quickAddStock(itemName, quantity) {
            addStock(itemName, quantity);
        }

        function quickRemoveStock(itemName, quantity) {
            const item = inventory[itemName];
            if (!item) return;
            const newStock = Math.max(0, item.currentStock - quantity);
            setStock(itemName, newStock);
        }

        function getRemovedMenuItems() {
            const removed = localStorage.getItem('removedMenuItems');
            if (!removed) return [];
            try {
                const list = JSON.parse(removed);
                return Array.isArray(list) ? list : [];
            } catch (error) {
                return [];
            }
        }

        function saveRemovedMenuItems(list) {
            localStorage.setItem('removedMenuItems', JSON.stringify(list));
        }

        function removeMenuItem(itemName, options) {
            const settings = options || {};
            const skipConfirm = settings.skipConfirm === true;
            const persist = settings.persist !== false;

            if (!skipConfirm) {
                const ok = confirm(`Remove ${itemName} from menu and inventory? This cannot be undone.`);
                if (!ok) return;
            }

            delete menuItems[itemName];
            if (inventory[itemName]) {
                delete inventory[itemName];
                saveInventory();
            }

            if (typeof cart !== 'undefined' && cart[itemName]) {
                delete cart[itemName];
                updateCartBar();
            }

            const menuItemsElements = document.querySelectorAll('.menu-item');
            menuItemsElements.forEach(function(element) {
                if (element.getAttribute('data-name') === itemName) {
                    element.remove();
                }
            });

            if (persist) {
                const removedItems = getRemovedMenuItems();
                if (!removedItems.includes(itemName)) {
                    removedItems.push(itemName);
                    saveRemovedMenuItems(removedItems);
                }
                localStorage.setItem('customMenuItems', JSON.stringify(menuItems));
            }

            updateStockDisplay();
            updateInventoryDashboard();
        }

        function applyRemovedMenuItems() {
            const removedItems = getRemovedMenuItems();
            if (removedItems.length === 0) return;
            removedItems.forEach(function(itemName) {
                removeMenuItem(itemName, { skipConfirm: true, persist: false });
            });
        }

        function resetInventory() {
            if (confirm('Are you sure you want to reset all inventory to default values?')) {
                inventory = {};
                for (const itemName in defaultInventory) {
                    inventory[itemName] = { ...defaultInventory[itemName], lastRestocked: new Date().toISOString() };
                }
                saveInventory();
                updateStockDisplay();
                updateInventoryDashboard();
                alert('Inventory reset successfully!');
            }
        }

        function exportInventory() {
            const headers = [
                'item',
                'currentStock',
                'unit',
                'lowThreshold',
                'criticalThreshold',
                'category',
                'lastRestocked'
            ];

            const rows = [headers.join(',')];

            for (const itemName in inventory) {
                const item = inventory[itemName] || {};
                const values = [
                    itemName,
                    item.currentStock ?? '',
                    item.unit ?? '',
                    item.lowThreshold ?? '',
                    item.criticalThreshold ?? '',
                    item.category ?? '',
                    item.lastRestocked ?? ''
                ].map(function(value) {
                    const text = String(value);
                    return '"' + text.replace(/"/g, '""') + '"';
                });
                rows.push(values.join(','));
            }

            const dataStr = rows.join('\n');
            const dataBlob = new Blob([dataStr], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `inventory_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // ===================================
        // ADD NEW MENU ITEM
        // ===================================
        function openAddNewItem() {
            var modal = document.getElementById('add-item-modal');
            modal.classList.add('active');
            var form = document.getElementById('new-item-form');
            if (form) form.reset();
        }

        function closeAddNewItem() {
            var modal = document.getElementById('add-item-modal');
            modal.classList.remove('active');
        }

        function renderNewMenuItem(itemName, price, category) {
            // Check if item already exists
            const existing = document.querySelector(`[data-name="${itemName}"]`);
            if (existing) return; // Item already rendered
            
            // Map category to display name
            const categoryMap = {
                'Beverages': '‚òï Beverages',
                'Snacks': 'üç™ Snacks',
                'Tiffin/Meals': 'üçõ Tiffin/Meals'
            };
            
            // Find the menu grid for this category
            const categoryTitle = categoryMap[category] || category;
            const categories = document.querySelectorAll('.category-title');
            let menuGrid = null;
            
            for (let cat of categories) {
                if (cat.textContent.includes(categoryTitle)) {
                    menuGrid = cat.closest('.category').querySelector('.menu-grid');
                    break;
                }
            }
            
            // If category not found, create it
            if (!menuGrid) {
                const menuContainer = document.querySelector('.menu-container');
                const newCategory = document.createElement('div');
                newCategory.className = 'category';
                newCategory.innerHTML = `
                    <h3 class="category-title">${categoryTitle}</h3>
                    <div class="menu-grid"></div>
                `;
                menuContainer.appendChild(newCategory);
                menuGrid = newCategory.querySelector('.menu-grid');
            }
            
            // Create the menu item HTML
            const menuItem = document.createElement('div');
            menuItem.className = 'menu-item';
            menuItem.setAttribute('data-name', itemName);
            menuItem.setAttribute('data-price', price);
            menuItem.innerHTML = `
                <div class="item-info">
                    <span class="item-name">${itemName}</span>
                    <span class="item-price">‚Çπ${price}</span>
                </div>
                <div class="item-controls">
                    <button class="btn-minus" onclick="updateQuantity('${itemName}', -1)">‚àí</button>
                    <span class="quantity" id="qty-${itemName}">0</span>
                    <button class="btn-plus" onclick="updateQuantity('${itemName}', 1)">+</button>
                </div>
            `;
            
            // Append to menu grid
            menuGrid.appendChild(menuItem);
            
            // Update stock indicator for the new item
            updateStockDisplay();
        }

        function renderAllCustomItems() {
            // Load and render all custom items from menuItems that aren't already on the page
            for (const itemName in menuItems) {
                // Skip default items that are already in the HTML
                const defaultItems = ['Tea', 'Coffee', 'Horlicks', 'Boost', 'Vada', 'Idly (Plate)', 'Poori (Plate)', 'Dosa', 'Masal Dosa', 'Paper Roast', 'Ghee Roast', 'Onion Dosa', 'Uthappam', 'Onion Uthappam', 'Chapathi', 'Porota (Plate)', 'Meals'];
                if (defaultItems.includes(itemName)) continue;
                
                // Check if already rendered
                if (document.querySelector(`[data-name="${itemName}"]`)) continue;
                
                // Get category from inventory if available
                const category = (inventory[itemName] && inventory[itemName].category) || 'Other';
                const price = menuItems[itemName];
                
                // Render this custom item
                renderNewMenuItem(itemName, price, category);
            }
        }

        function addNewMenuItem() {
            const name = document.getElementById('new-item-name').value.trim();
            const price = parseFloat(document.getElementById('new-item-price').value);
            const category = document.getElementById('new-item-category').value;
            const stock = parseInt(document.getElementById('new-item-stock').value);
            const unit = document.getElementById('new-item-unit').value.trim();
            const lowThreshold = parseInt(document.getElementById('new-item-low-threshold').value);
            const criticalThreshold = parseInt(document.getElementById('new-item-critical-threshold').value);
            
            if (!name || !price || !stock || !unit || !lowThreshold || !criticalThreshold) {
                alert('Please fill in all fields');
                return;
            }
            
            if (menuItems[name]) {
                alert('An item with this name already exists!');
                return;
            }
            
            menuItems[name] = price;
            inventory[name] = {
                currentStock: stock,
                unit: unit,
                lowThreshold: lowThreshold,
                criticalThreshold: criticalThreshold,
                category: category,
                lastRestocked: new Date().toISOString()
            };
            
            localStorage.setItem('customMenuItems', JSON.stringify(menuItems));
            saveInventory();
            
            // Dynamically render the new item
            renderNewMenuItem(name, price, category);
            
            alert(`${name} added successfully!`);
            closeAddNewItem();
        }

        // ===================================
        // ANALYTICS DASHBOARD
        // ===================================
        function openAnalyticsDashboard() {
            var modal = document.getElementById('analytics-modal');
            modal.classList.add('active');
            updateAnalyticsDashboard('today');
        }

        function closeAnalyticsDashboard() {
            var modal = document.getElementById('analytics-modal');
            modal.classList.remove('active');
        }

        function isFirebaseAnalyticsReady() {
            return typeof firebase !== 'undefined' &&
                firebase.apps &&
                firebase.apps.length > 0 &&
                typeof getOrdersFromFirebase === 'function';
        }

        async function fetchOrdersForPeriod(period) {
            let periodLabel = '';
            let startDate = null;
            let endDate = null;

            if (period === 'today') {
                startDate = new Date();
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 1);
                periodLabel = 'Today';
            } else if (period === 'month') {
                const now = new Date();
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                periodLabel = 'This Month';
            } else if (period === 'year') {
                const now = new Date();
                startDate = new Date(now.getFullYear(), 0, 1);
                endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59);
                periodLabel = 'This Year';
            } else if (period === 'custom') {
                startDate = new Date(document.getElementById('analytics-start-date').value);
                endDate = new Date(document.getElementById('analytics-end-date').value);
                endDate.setHours(23, 59, 59);
                periodLabel = 'Custom Range';
            }

            if (!startDate || !endDate || isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                return { orders: [], periodLabel: periodLabel || 'Custom Range' };
            }

            let orders = [];
            if (isFirebaseAnalyticsReady()) {
                try {
                    orders = await getOrdersFromFirebase(startDate, endDate);
                } catch (error) {
                    console.warn('Firebase analytics unavailable, using local history.', error);
                    orders = getOrdersByDateRange(startDate, endDate);
                }
            } else {
                orders = getOrdersByDateRange(startDate, endDate);
            }

            // Fallback to local history if Firebase returns no data
            if (orders.length === 0) {
                const localOrders = getOrdersByDateRange(startDate, endDate);
                if (localOrders.length > 0) {
                    orders = localOrders;
                }
            }

            return { orders, periodLabel };
        }

        async function updateAnalyticsDashboard(period) {
            const result = await fetchOrdersForPeriod(period);
            const orders = result.orders;
            const periodLabel = result.periodLabel;
            
            const periodLabelElement = document.getElementById('analytics-period-label');
            if (periodLabelElement) periodLabelElement.textContent = periodLabel;
            
            const totalOrders = orders.length;
            const totalRevenue = calculateRevenue(orders);
            const avgOrderValue = totalOrders > 0 ? (totalRevenue / totalOrders).toFixed(2) : 0;
            
            const statTotalOrders = document.getElementById('stat-total-orders');
            const statTotalRevenue = document.getElementById('stat-total-revenue');
            const statAvgOrder = document.getElementById('stat-avg-order');
            
            if (statTotalOrders) statTotalOrders.textContent = totalOrders;
            if (statTotalRevenue) statTotalRevenue.textContent = `‚Çπ${totalRevenue}`;
            if (statAvgOrder) statAvgOrder.textContent = `‚Çπ${avgOrderValue}`;
            
            displayHourlyTraffic(getHourlyTraffic(orders));
            displayTopSellingItems(getTopSellingItems(orders));
            displayOrderList(orders);
        }

        function displayHourlyTraffic(hourlyData) {
            const container = document.getElementById('hourly-traffic-chart');
            if (!container) return;
            container.innerHTML = '';
            
            let peakHour = 0;
            let peakCount = 0;
            
            for (let hour in hourlyData) {
                if (hourlyData[hour].count > peakCount) {
                    peakCount = hourlyData[hour].count;
                    peakHour = hour;
                }
            }
            
            for (let hour = 0; hour < 24; hour++) {
                const data = hourlyData[hour];
                const barContainer = document.createElement('div');
                barContainer.className = 'traffic-bar-container';
                
                const percentage = peakCount > 0 ? (data.count / peakCount) * 100 : 0;
                const isPeak = hour == peakHour && data.count > 0;
                
                barContainer.innerHTML = `
                    <div class="traffic-hour">${hour}:00</div>
                    <div class="traffic-bar-wrapper">
                        <div class="traffic-bar ${isPeak ? 'peak' : ''}" style="height: ${percentage}%">
                            <span class="traffic-count">${data.count}</span>
                        </div>
                    </div>
                    <div class="traffic-revenue">‚Çπ${data.revenue}</div>
                `;
                
                container.appendChild(barContainer);
            }
            
            const peakHourInfo = document.getElementById('peak-hour-info');
            if (peakHourInfo) {
                peakHourInfo.textContent = peakCount > 0 ? 
                    `Peak Hour: ${peakHour}:00 - ${parseInt(peakHour) + 1}:00 (${peakCount} orders, ‚Çπ${hourlyData[peakHour].revenue})` : 
                    'No orders yet';
            }
        }

        function displayTopSellingItems(items) {
            const container = document.getElementById('top-items-list');
            if (!container) return;
            container.innerHTML = '';
            
            const topTen = items.slice(0, 10);
            
            if (topTen.length === 0) {
                container.innerHTML = '<p class="no-data">No sales data available</p>';
                return;
            }
            
            topTen.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'top-item';
                
                itemElement.innerHTML = `
                    <div class="top-item-rank">#${index + 1}</div>
                    <div class="top-item-info">
                        <div class="top-item-name">${item.name}</div>
                        <div class="top-item-stats">Sold: ${item.count} | Revenue: ‚Çπ${item.revenue}</div>
                    </div>
                `;
                
                container.appendChild(itemElement);
            });
        }

        function displayOrderList(orders) {
            const container = document.getElementById('order-list');
            if (!container) return;
            container.innerHTML = '';
            
            if (orders.length === 0) {
                container.innerHTML = '<p class="no-data">No orders found</p>';
                return;
            }
            
            const sortedOrders = [...orders].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            sortedOrders.forEach(order => {
                const orderElement = document.createElement('div');
                orderElement.className = 'order-record';
                
                const timestamp = new Date(order.timestamp);
                const dateStr = timestamp.toLocaleDateString();
                const timeStr = timestamp.toLocaleTimeString();
                
                const itemsList = order.items.map(item => `${item.name} x${item.qty}`).join(', ');
                
                orderElement.innerHTML = `
                    <div class="order-record-header">
                        <span class="order-id">Order #${order.id}</span>
                        <span class="order-total">‚Çπ${order.total}</span>
                    </div>
                    <div class="order-record-details">
                        <div><strong>Table:</strong> ${order.table}</div>
                        <div><strong>Date:</strong> ${dateStr}</div>
                        <div><strong>Time:</strong> ${timeStr}</div>
                        <div><strong>Items:</strong> ${itemsList}</div>
                    </div>
                `;
                
                container.appendChild(orderElement);
            });
        }

        function exportAnalyticsReport() {
            const period = document.querySelector('.analytics-filter-btn.active')?.getAttribute('data-period') || 'today';
            let orders = [];
            
            if (period === 'today') {
                orders = getTodayOrders();
            } else if (period === 'month') {
                orders = getMonthOrders();
            } else if (period === 'year') {
                orders = getYearOrders();
            }

            const generatedAt = new Date().toISOString();
            const headers = [
                'period',
                'generatedAt',
                'orderId',
                'table',
                'timestamp',
                'time',
                'total',
                'items'
            ];

            const rows = [headers.join(',')];

            orders.forEach(function(order) {
                const itemsList = order.items.map(function(item) {
                    return item.name + ' x' + item.qty;
                }).join('; ');

                const values = [
                    period,
                    generatedAt,
                    order.id,
                    order.table,
                    order.timestamp,
                    order.time || '',
                    order.total,
                    itemsList
                ].map(function(value) {
                    const text = String(value ?? '');
                    return '"' + text.replace(/"/g, '""') + '"';
                });

                rows.push(values.join(','));
            });

            const dataStr = rows.join('\n');
            const dataBlob = new Blob([dataStr], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `analytics_report_${period}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function clearOrderHistory() {
            if (confirm('Are you sure you want to delete ALL order history? This cannot be undone!')) {
                localStorage.removeItem('orderHistory');
                alert('Order history cleared successfully!');
                updateAnalyticsDashboard('today');
            }
        }

        // ===================================
        // INITIALIZATION
        // ===================================
        function init() {
            console.log('üçΩÔ∏è Smart Restaurant Ordering System Initialized');
            
            const customItems = localStorage.getItem('customMenuItems');
            if (customItems) {
                Object.assign(menuItems, JSON.parse(customItems));
            }
            
            initializeInventory();
            applyRemovedMenuItems();
            
            // Render all custom items that were saved (this fixes the menu not showing custom items after refresh)
            renderAllCustomItems();
            
            const savedIP = localStorage.getItem('esp32-ip');
            if (savedIP) {
                document.getElementById('esp32-ip').value = savedIP;
            }
            
            document.getElementById('esp32-ip').addEventListener('change', function() {
                localStorage.setItem('esp32-ip', this.value);
            });
            
            updateCartBar();
            updateStockDisplay();
            
            console.log('‚úÖ System Ready!');
        }

        // ===================================
        // AUTHENTICATION UI
        // ===================================
        function setAuthMessage(text) {
            const message = document.getElementById('auth-message');
            if (message) {
                message.textContent = text || '';
            }
        }

        // Whitelist of authorized staff emails
        const AUTHORIZED_EMAILS = [
            'sharunandha21@gmail.com',
            'admin321@restaurant.com'
        ];

        function setAuthLocked(locked) {
            const overlay = document.getElementById('auth-overlay');
            const logoutBtn = document.getElementById('btn-logout');
            const status = document.getElementById('auth-status');

            if (locked) {
                document.body.classList.add('auth-locked');
                if (overlay) overlay.classList.remove('hidden');
                if (logoutBtn) logoutBtn.style.display = 'none';
                if (status) status.textContent = 'Signed out';
            } else {
                document.body.classList.remove('auth-locked');
                if (overlay) overlay.classList.add('hidden');
                if (logoutBtn) logoutBtn.style.display = 'inline-flex';
                if (status) status.textContent = 'Signed in';
            }
        }

        function initAuthUI() {
            if (typeof firebase === 'undefined' || !firebase.auth) {
                setAuthMessage('Auth not ready. Please refresh the page.');
                setAuthLocked(true);
                return;
            }

            firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(function(error) {
                console.warn('Auth persistence error:', error);
            });

            firebase.auth().onAuthStateChanged(function(user) {
                if (user && AUTHORIZED_EMAILS.includes(user.email)) {
                    // Authorized user
                    setAuthLocked(false);
                } else if (user) {
                    // Unauthorized user - sign them out
                    setAuthMessage('Email not authorized. Contact your restaurant admin.');
                    firebase.auth().signOut();
                    setAuthLocked(true);
                } else {
                    // No user
                    setAuthLocked(true);
                }
            });
        }

        function loginUser() {
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value;

            if (!email || !password) {
                setAuthMessage('Enter email and password.');
                return;
            }

            // Check whitelist before attempting login
            if (!AUTHORIZED_EMAILS.includes(email)) {
                setAuthMessage('Email not authorized. Contact your restaurant admin.');
                return;
            }

            setAuthMessage('Signing in...');
            firebase.auth().signInWithEmailAndPassword(email, password)
                .then(function() {
                    setAuthMessage('');
                })
                .catch(function(error) {
                    setAuthMessage(error.message);
                });
        }

        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            setAuthMessage('Opening Google sign-in...');
            firebase.auth().signInWithPopup(provider)
                .then(function() {
                    setAuthMessage('');
                })
                .catch(function(error) {
                    setAuthMessage(error.message);
                });
        }

        function logoutUser() {
            firebase.auth().signOut().catch(function(error) {
                console.warn('Logout failed:', error);
            });
        }

        // ===================================
        // MAKE ALL FUNCTIONS GLOBAL
        // ===================================
        window.updateQuantity = updateQuantity;
        window.openCheckout = openCheckout;
        window.closeCheckout = closeCheckout;
        window.confirmOrder = confirmOrder;
        window.closeConfirmation = closeConfirmation;
        window.testConnection = testConnection;
        window.openInventoryDashboard = openInventoryDashboard;
        window.closeInventoryDashboard = closeInventoryDashboard;
        window.openAnalyticsDashboard = openAnalyticsDashboard;
        window.closeAnalyticsDashboard = closeAnalyticsDashboard;
        window.openAddNewItem = openAddNewItem;
        window.closeAddNewItem = closeAddNewItem;
        window.addNewMenuItem = addNewMenuItem;
        window.renderNewMenuItem = renderNewMenuItem;
        window.renderAllCustomItems = renderAllCustomItems;
        window.openStockAdjust = openStockAdjust;
        window.closeStockAdjust = closeStockAdjust;
        window.applyStockAdjustment = applyStockAdjustment;
        window.quickAddStock = quickAddStock;
        window.quickRemoveStock = quickRemoveStock;
        window.removeMenuItem = removeMenuItem;
        window.resetInventory = resetInventory;
        window.exportInventory = exportInventory;
        window.updateAnalyticsDashboard = updateAnalyticsDashboard;
        window.exportAnalyticsReport = exportAnalyticsReport;
        window.clearOrderHistory = clearOrderHistory;
        window.loginUser = loginUser;
        window.registerUser = registerUser;
        window.signInWithGoogle = signInWithGoogle;
        window.logoutUser = logoutUser;

        // Initialize on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            const targetElement = event.target;
            const isFormInput = targetElement.tagName === 'INPUT' || targetElement.tagName === 'SELECT' || targetElement.tagName === 'TEXTAREA';
            
            if (event.key === 'c' || event.key === 'C') {
                // Don't trigger checkout if in a form input
                if (!isFormInput &&
                    !document.getElementById('checkout-modal').classList.contains('active') &&
                    !document.getElementById('confirmation-modal').classList.contains('active') &&
                    !document.getElementById('add-item-modal').classList.contains('active')) {
                    openCheckout();
                }
            }
            
            if (event.key === 'Escape') {
                closeCheckout();
                closeConfirmation();
                closeInventoryDashboard();
                closeAnalyticsDashboard();
                closeAddNewItem();
                closeStockAdjust();
            }
        });

        console.log('‚úÖ ALL FUNCTIONS LOADED - Restaurant System Ready!');
    </script>

    <!-- Firebase Config & Integration -->
    <script src="firebase-config.js"></script>
    
    <script>
        // Initialize Firebase sync when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(function() {
                    if (typeof initFirebaseSync === 'function') {
                        initFirebaseSync();
                        console.log('üî• Firebase sync initialized');
                    }
                    if (typeof initAuthUI === 'function') {
                        initAuthUI();
                    }
                }, 1000);
            });
        } else {
            setTimeout(function() {
                if (typeof initFirebaseSync === 'function') {
                    initFirebaseSync();
                    console.log('üî• Firebase sync initialized');
                }
                if (typeof initAuthUI === 'function') {
                    initAuthUI();
                }
            }, 1000);
        }
    </script>
</body>
</html>
